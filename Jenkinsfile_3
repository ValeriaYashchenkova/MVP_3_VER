pipeline {
    agent {
        kubernetes {
            inheritFrom 'python'
            defaultContainer 'python-builder'
        }
    }

    parameters {
        string(
            name: 'BRANCH_NAME',
            defaultValue: 'master',
            description: 'Ветка для запуска SQL проверок'
        )
    }

    environment {
        ALLURE_RESULTS = "allure-results"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '20'))
        timestamps()
    }

    stages {

        stage('Clean workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout repository') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "${params.BRANCH_NAME}"]],
                    userRemoteConfigs: [[
                        url: 'https://git.moscow.alfaintra.net/scm/bialm_ft/bialm_ft_auto.git',
                        credentialsId: 'git_pass'
                    ]]
                ])
            }
        }

        stage('Show workspace (debug)') {
            steps {
                sh '''
                    echo "Current directory:"
                    pwd
                    echo "Files:"
                    ls -la
                '''
            }
        }

        stage('Create virtualenv & install deps') {
            steps {
                sh '''
                    python3.11 -m venv venv

                    venv/bin/pip install --upgrade pip \
                      -i https://binary.alfabank.ru/artifactory/api/pypi/pipy-virtual/simple

                    venv/bin/pip install \
                      oracledb tomli requests \
                      -i https://binary.alfabank.ru/artifactory/api/pypi/pipy-virtual/simple
                '''
            }
        }

        stage('Run SQL checks') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'oracle-db-creds',
                        usernameVariable: 'DB_USER',
                        passwordVariable: 'DB_PASS'
                    )
                ]) {
                    sh '''
                        echo "DB_USER detected: ${DB_USER:+YES}"
                        echo "Starting tests..."

                        venv/bin/python run_test.py --branch "${BRANCH_NAME}"
                    '''
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'allure-results/**', allowEmptyArchive: true
            cleanWs()
        }
    }
}
